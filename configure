#!/bin/bash

# MyShell Configuration Script
# Checks and installs dependencies required to build MyShell

set -e  # Exit on error

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Print colored messages
print_success() { echo -e "${GREEN}✓${NC} $1"; }
print_error() { echo -e "${RED}✗${NC} $1"; }
print_warning() { echo -e "${YELLOW}⚠${NC} $1"; }
print_info() { echo -e "${BLUE}ℹ${NC} $1"; }

echo "======================================"
echo "   MyShell Configuration Script"
echo "======================================"
echo ""

# Detect OS
print_info "Detecting operating system..."
if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS=$ID
    OS_VERSION=$VERSION_ID
    print_success "Detected: $PRETTY_NAME"
else
    print_error "Cannot detect OS. /etc/os-release not found."
    exit 1
fi

echo ""
print_info "Checking dependencies..."
echo ""

# Check if running as root (for package installation)
if [ "$EUID" -eq 0 ]; then 
    SUDO=""
else
    SUDO="sudo"
fi

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Track what needs to be installed
MISSING_PACKAGES=()

# Check for GCC
if command_exists gcc; then
    GCC_VERSION=$(gcc --version | head -n1 | awk '{print $NF}')
    print_success "GCC found (version $GCC_VERSION)"
else
    print_warning "GCC not found"
    MISSING_PACKAGES+=("gcc")
fi

# Check for Make
if command_exists make; then
    MAKE_VERSION=$(make --version | head -n1 | awk '{print $NF}')
    print_success "Make found (version $MAKE_VERSION)"
else
    print_warning "Make not found"
    MISSING_PACKAGES+=("make")
fi

# Check for standard C library headers
echo ""
print_info "Checking for development headers..."
if [ -f /usr/include/stdio.h ]; then
    print_success "Standard C headers found"
else
    print_warning "Standard C headers not found"
    case $OS in
        ubuntu|debian)
            MISSING_PACKAGES+=("build-essential")
            ;;
        fedora|rhel|centos)
            MISSING_PACKAGES+=("glibc-devel")
            ;;
        arch)
            MISSING_PACKAGES+=("base-devel")
            ;;
    esac
fi

# Install missing packages if any
if [ ${#MISSING_PACKAGES[@]} -gt 0 ]; then
    echo ""
    print_warning "Missing packages: ${MISSING_PACKAGES[*]}"
    echo ""
    read -p "Do you want to install missing packages? (y/n) " -n 1 -r
    echo ""
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        print_info "Installing packages..."
        
        case $OS in
            ubuntu|debian)
                $SUDO apt-get update
                $SUDO apt-get install -y "${MISSING_PACKAGES[@]}"
                ;;
            fedora)
                $SUDO dnf install -y "${MISSING_PACKAGES[@]}"
                ;;
            centos|rhel)
                $SUDO yum install -y "${MISSING_PACKAGES[@]}"
                ;;
            arch)
                $SUDO pacman -S --noconfirm "${MISSING_PACKAGES[@]}"
                ;;
            *)
                print_error "Package installation not supported for $OS"
                print_info "Please manually install: ${MISSING_PACKAGES[*]}"
                exit 1
                ;;
        esac
        
        print_success "Packages installed successfully"
    else
        print_warning "Skipping package installation"
        print_info "You may need to install these manually: ${MISSING_PACKAGES[*]}"
        exit 1
    fi
fi

echo ""
print_info "Verifying installation..."

# Verify all tools are now available
ALL_OK=true

if ! command_exists gcc; then
    print_error "GCC still not found"
    ALL_OK=false
else
    print_success "GCC is available"
fi

if ! command_exists make; then
    print_error "Make still not found"
    ALL_OK=false
else
    print_success "Make is available"
fi

# Test compilation
echo ""
print_info "Testing compiler..."
TEST_FILE=$(mktemp --suffix=.c)
cat > "$TEST_FILE" <<'EOF'
#include <stdio.h>
int main() { printf("test\n"); return 0; }
EOF

if gcc -std=c99 -o "${TEST_FILE}.out" "$TEST_FILE" 2>/dev/null; then
    print_success "Compiler test passed"
    rm -f "$TEST_FILE" "${TEST_FILE}.out"
else
    print_error "Compiler test failed"
    rm -f "$TEST_FILE"
    ALL_OK=false
fi

echo ""
if [ "$ALL_OK" = true ]; then
    print_success "All dependencies satisfied!"
    echo ""
    print_info "You can now build MyShell with:"
    echo "    make"
    echo ""
    print_info "After building, run MyShell with:"
    echo "    ./mysh"
    echo ""
    print_info "For verbose logging:"
    echo "    ./mysh -v CONSOLE"
    echo ""
    print_info "For help:"
    echo "    ./mysh --help"
    echo ""
    echo "======================================"
    exit 0
else
    print_error "Some dependencies are still missing"
    echo ""
    print_info "Please resolve the issues above and run configure again"
    exit 1
fi
